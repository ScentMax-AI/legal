  <!DOCTYPE html>
  <html lang="en">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Reset Password - ScentMax AI</title>
      <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
      <style>
          * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
          }
          body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              background: #0D0D0F;
              min-height: 100vh;
              display: flex;
              justify-content: center;
              align-items: center;
              padding: 20px;
          }
          .container {
              background: #18181B;
              border-radius: 20px;
              padding: 40px;
              max-width: 400px;
              width: 100%;
              box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
              border: 1px solid rgba(255, 122, 69, 0.15);
          }
          .logo {
              text-align: center;
              margin-bottom: 24px;
          }
          .logo-text {
              font-size: 28px;
              font-weight: 800;
              background: linear-gradient(135deg, #FF7A45, #E84393, #9B59B6);
              -webkit-background-clip: text;
              -webkit-text-fill-color: transparent;
              background-clip: text;
          }
          h1 {
              color: #FAFAFA;
              font-size: 24px;
              font-weight: 600;
              text-align: center;
              margin-bottom: 8px;
          }
          .subtitle {
              color: #A1A1AA;
              text-align: center;
              margin-bottom: 32px;
              font-size: 15px;
          }
          .form-group {
              margin-bottom: 20px;
          }
          label {
              display: block;
              color: #FAFAFA;
              font-size: 14px;
              font-weight: 500;
              margin-bottom: 8px;
          }
          input {
              width: 100%;
              padding: 16px;
              border: 1px solid rgba(255, 122, 69, 0.2);
              border-radius: 12px;
              background: #0D0D0F;
              color: #FAFAFA;
              font-size: 16px;
              transition: border-color 0.2s, box-shadow 0.2s;
          }
          input:focus {
              outline: none;
              border-color: #FF7A45;
              box-shadow: 0 0 0 3px rgba(255, 122, 69, 0.15);
          }
          input::placeholder {
              color: #71717A;
          }
          button {
              width: 100%;
              padding: 16px;
              border: none;
              border-radius: 12px;
              background: linear-gradient(135deg, #FF7A45, #E84393);
              color: white;
              font-size: 16px;
              font-weight: 700;
              cursor: pointer;
              transition: transform 0.2s, box-shadow 0.2s;
              margin-top: 8px;
          }
          button:hover {
              transform: translateY(-2px);
              box-shadow: 0 8px 24px rgba(232, 67, 147, 0.4);
          }
          button:disabled {
              opacity: 0.6;
              cursor: not-allowed;
              transform: none;
          }
          .message {
              padding: 16px;
              border-radius: 12px;
              margin-bottom: 20px;
              text-align: center;
              font-size: 14px;
          }
          .error {
              background: rgba(239, 68, 68, 0.15);
              color: #EF4444;
              border: 1px solid rgba(239, 68, 68, 0.3);
          }
          .success {
              background: rgba(34, 197, 94, 0.15);
              color: #22C55E;
              border: 1px solid rgba(34, 197, 94, 0.3);
          }
          .loading {
              display: flex;
              flex-direction: column;
              align-items: center;
              padding: 60px 20px;
          }
          .spinner {
              width: 48px;
              height: 48px;
              border: 3px solid rgba(255, 122, 69, 0.2);
              border-top-color: #FF7A45;
              border-radius: 50%;
              animation: spin 1s linear infinite;
          }
          @keyframes spin {
              to { transform: rotate(360deg); }
          }
          .loading-text {
              color: #A1A1AA;
              margin-top: 16px;
              font-size: 15px;
          }
          .hidden {
              display: none;
          }
          .back-link {
              display: block;
              text-align: center;
              color: #A1A1AA;
              text-decoration: none;
              margin-top: 24px;
              font-size: 14px;
              transition: color 0.2s;
          }
          .back-link:hover {
              color: #FF7A45;
          }
      </style>
  </head>
  <body>
      <div class="container">
          <div class="logo">
              <span class="logo-text">ScentMax AI</span>
          </div>

          <div id="loading" class="loading">
              <div class="spinner"></div>
              <p class="loading-text">Verifying reset link...</p>
          </div>

          <div id="form-container" class="hidden">
              <h1>Set New Password</h1>
              <p class="subtitle">Enter your new password below</p>

              <div id="message" class="message hidden"></div>

              <form id="reset-form">
                  <div class="form-group">
                      <label for="password">New Password</label>
                      <input type="password" id="password" placeholder="Enter new password" required minlength="8">
                  </div>
                  <div class="form-group">
                      <label for="confirm">Confirm Password</label>
                      <input type="password" id="confirm" placeholder="Confirm new password" required minlength="8">
                  </div>
                  <button type="submit" id="submit-btn">Update Password</button>
              </form>
          </div>

          <div id="error-container" class="hidden">
              <h1>Link Expired</h1>
              <p class="subtitle">This reset link is invalid or has expired.</p>
              <div class="message error">Please request a new password reset from the app.</div>
          </div>

          <div id="success-container" class="hidden">
              <h1>Password Updated!</h1>
              <p class="subtitle">Your password has been successfully changed.</p>
              <div class="message success">You can now sign in with your new password in the ScentMax app.</div>
          </div>
      </div>

      <script>
          const SUPABASE_URL = 'https://rkttvbvfkoazxbfzpjba.supabase.co';
          const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJrdHR2YnZma29henhiZnpwamJhIiwicm9sZSI6ImFub24iLCJpYXQi
  OjE3NjQ2NTA3OTAsImV4cCI6MjA4MDIyNjc5MH0.soecDP5vtKbx-oixZP8e0Y2K9FLnAIt4mv2XDXM-_-s';

          const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

          const loading = document.getElementById('loading');
          const formContainer = document.getElementById('form-container');
          const errorContainer = document.getElementById('error-container');
          const successContainer = document.getElementById('success-container');
          const resetForm = document.getElementById('reset-form');
          const messageDiv = document.getElementById('message');
          const submitBtn = document.getElementById('submit-btn');

          function showError(msg) {
              loading.classList.add('hidden');
              formContainer.classList.add('hidden');
              successContainer.classList.add('hidden');
              errorContainer.classList.remove('hidden');
              if (msg) {
                  errorContainer.querySelector('.message').textContent = msg;
              }
          }

          function showSuccess() {
              loading.classList.add('hidden');
              formContainer.classList.add('hidden');
              errorContainer.classList.add('hidden');
              successContainer.classList.remove('hidden');
          }

          function showForm() {
              loading.classList.add('hidden');
              errorContainer.classList.add('hidden');
              successContainer.classList.add('hidden');
              formContainer.classList.remove('hidden');
          }

          function showMessage(msg, isError) {
              messageDiv.textContent = msg;
              messageDiv.className = 'message ' + (isError ? 'error' : 'success');
              messageDiv.classList.remove('hidden');
          }

          async function init() {
              try {
                  const hash = window.location.hash.substring(1);
                  const params = new URLSearchParams(hash);
                  const accessToken = params.get('access_token');
                  const refreshToken = params.get('refresh_token');
                  const type = params.get('type');

                  console.log('Init - type:', type, 'hasTokens:', !!accessToken && !!refreshToken);

                  if (!accessToken || !refreshToken || type !== 'recovery') {
                      showError('Invalid or expired reset link. Please request a new one from the app.');
                      return;
                  }

                  const { data, error } = await supabase.auth.setSession({
                      access_token: accessToken,
                      refresh_token: refreshToken
                  });

                  if (error) {
                      console.error('Session error:', error);
                      showError('This reset link has expired. Please request a new one from the app.');
                      return;
                  }

                  if (data.session) {
                      console.log('Session established');
                      showForm();
                  } else {
                      showError('Could not verify reset link. Please try again.');
                  }
              } catch (err) {
                  console.error('Init error:', err);
                  showError('An error occurred. Please try again.');
              }
          }

          resetForm.addEventListener('submit', async (e) => {
              e.preventDefault();

              const password = document.getElementById('password').value;
              const confirm = document.getElementById('confirm').value;

              if (password.length < 8) {
                  showMessage('Password must be at least 8 characters', true);
                  return;
              }

              if (password !== confirm) {
                  showMessage('Passwords do not match', true);
                  return;
              }

              submitBtn.disabled = true;
              submitBtn.textContent = 'Updating...';
              messageDiv.classList.add('hidden');

              try {
                  const { error } = await supabase.auth.updateUser({ password });

                  if (error) {
                      showMessage(error.message, true);
                      submitBtn.disabled = false;
                      submitBtn.textContent = 'Update Password';
                      return;
                  }

                  await supabase.auth.signOut();
                  showSuccess();
              } catch (err) {
                  console.error('Update error:', err);
                  showMessage('Failed to update password. Please try again.', true);
                  submitBtn.disabled = false;
                  submitBtn.textContent = 'Update Password';
              }
          });

          init();
      </script>
  </body>
  </html>
